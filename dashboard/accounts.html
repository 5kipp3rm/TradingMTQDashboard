<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management - TradingMTQ</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/accounts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1><i class="fas fa-users"></i> Account Management</h1>
                <div class="header-actions">
                    <button id="addAccountBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Account
                    </button>
                    <button id="connectAllBtn" class="btn btn-success">
                        <i class="fas fa-plug"></i> Connect All
                    </button>
                    <button id="disconnectAllBtn" class="btn btn-danger">
                        <i class="fas fa-power-off"></i> Disconnect All
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        </header>

        <!-- Account Summary Cards -->
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="summary-content">
                    <h3 id="totalAccounts">0</h3>
                    <p>Total Accounts</p>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h3 id="activeAccounts">0</h3>
                    <p>Active Accounts</p>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-plug"></i>
                </div>
                <div class="summary-content">
                    <h3 id="connectedAccounts">0</h3>
                    <p>Connected</p>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="summary-content">
                    <h3 id="demoAccounts">0</h3>
                    <p>Demo Accounts</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-group">
                <label for="filterStatus">Status:</label>
                <select id="filterStatus">
                    <option value="all">All Accounts</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterType">Type:</label>
                <select id="filterType">
                    <option value="all">All Types</option>
                    <option value="demo">Demo Only</option>
                    <option value="live">Live Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterConnection">Connection:</label>
                <select id="filterConnection">
                    <option value="all">All</option>
                    <option value="connected">Connected Only</option>
                    <option value="disconnected">Disconnected Only</option>
                </select>
            </div>
        </div>

        <!-- Accounts Table -->
        <div class="accounts-section">
            <div class="section-header">
                <h2>Trading Accounts</h2>
                <button id="refreshAccountsBtn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div class="table-container">
                <table id="accountsTable" class="accounts-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Account</th>
                            <th>Platform</th>
                            <th>Broker</th>
                            <th>Server</th>
                            <th>Type</th>
                            <th>Connection</th>
                            <th>Last Connected</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTableBody">
                        <tr class="loading-row">
                            <td colspan="9">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> Loading accounts...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Account</h2>
                <button class="modal-close" onclick="closeAccountModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="accountForm">
                <input type="hidden" id="accountId" value="">

                <div class="form-group">
                    <label for="accountName">Account Name *</label>
                    <input type="text" id="accountName" required placeholder="e.g., My Trading Account">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="accountNumber">Account Number / Login *</label>
                        <input type="number" id="accountNumber" required placeholder="12345678">
                        <small style="color: #666; font-size: 0.85em;">Your MT4/MT5 account number</small>
                    </div>
                    <div class="form-group">
                        <label for="platformType">Platform *</label>
                        <select id="platformType" required>
                            <option value="MT5" selected>MetaTrader 5 (MT5)</option>
                            <option value="MT4">MetaTrader 4 (MT4)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="server">Server *</label>
                        <input type="text" id="server" required placeholder="e.g., ICMarkets-Demo">
                        <small style="color: #666; font-size: 0.85em;">Your broker's server name</small>
                    </div>
                    <div class="form-group">
                        <label for="password">Password *</label>
                        <input type="password" id="password" placeholder="Account password">
                        <small style="color: #666; font-size: 0.85em;">Leave blank when editing to keep existing</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="broker">Broker (Optional)</label>
                    <input type="text" id="broker" placeholder="e.g., IC Markets">
                    <small style="color: #666; font-size: 0.85em;">Auto-populated after first connection</small>
                </div>

                <div class="form-checkboxes">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isDemo" checked>
                        Demo Account
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="isActive" checked>
                        Active
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="isDefault">
                        Set as Default
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Account
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Details Modal -->
    <div id="accountDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Account Details</h2>
                <button class="modal-close" onclick="closeAccountDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="accountDetailsContent" class="account-details">
                <!-- Populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAccountDetailsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Account Configuration Modal -->
    <div id="accountConfigModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="configModalTitle">Account Configuration</h2>
                <button class="modal-close" onclick="closeAccountConfigModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-tabs">
                <button class="tab-button active" data-tab="general">
                    <i class="fas fa-cog"></i> General Settings
                </button>
                <button class="tab-button" data-tab="risk">
                    <i class="fas fa-shield-alt"></i> Risk Management
                </button>
                <button class="tab-button" data-tab="currencies">
                    <i class="fas fa-coins"></i> Currency Pairs
                </button>
                <button class="tab-button" data-tab="strategy">
                    <i class="fas fa-chart-line"></i> Strategy
                </button>
                <button class="tab-button" data-tab="position">
                    <i class="fas fa-tasks"></i> Position Management
                </button>
            </div>

            <form id="accountConfigForm">
                <input type="hidden" id="configAccountId" value="">

                <!-- General Settings Tab -->
                <div id="generalTab" class="tab-content active">
                    <h3>General Configuration</h3>

                    <div class="form-group">
                        <label for="configSource">Configuration Mode</label>
                        <select id="configSource" name="config_source">
                            <option value="database">Database (Simple - All in UI)</option>
                            <option value="yaml">YAML File (Advanced - Version Control)</option>
                            <option value="hybrid" selected>Hybrid (YAML + UI Overrides) - Recommended</option>
                        </select>
                        <small class="form-help">
                            <strong>Database:</strong> Easy, managed entirely through web UI<br>
                            <strong>YAML:</strong> Advanced, version control friendly<br>
                            <strong>Hybrid:</strong> Credentials in DB, config in YAML (Best practice)
                        </small>
                    </div>

                    <div id="yamlPathSection" class="form-group">
                        <label for="configPath">YAML Config Path</label>
                        <input type="text" id="configPath" name="config_path"
                               placeholder="config/accounts/account-5012345678.yml">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="generateYAMLPath()">
                            <i class="fas fa-magic"></i> Auto-generate
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="exportToYAML()">
                            <i class="fas fa-download"></i> Export Current Config to YAML
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="portable">Multi-Instance Support (Portable Mode)</label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="portable" name="portable" checked>
                            Enable portable mode (Required for Phase 4 multi-instance)
                        </label>
                        <small class="form-help">
                            Portable mode allows multiple MT5 instances to run simultaneously without conflicts
                        </small>
                    </div>
                </div>

                <!-- Risk Management Tab -->
                <div id="riskTab" class="tab-content">
                    <h3>Risk Management Settings</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="riskPercent">Risk Per Trade (%)</label>
                            <input type="number" id="riskPercent" name="risk_percent"
                                   step="0.1" min="0.1" max="10" value="1.0">
                            <small class="form-help">Percentage of account balance to risk per trade</small>
                        </div>

                        <div class="form-group">
                            <label for="maxPositions">Max Positions Per Pair</label>
                            <input type="number" id="maxPositions" name="max_positions"
                                   min="1" max="20" value="5">
                            <small class="form-help">Maximum concurrent positions per currency pair</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxConcurrentTrades">Max Concurrent Trades (Total)</label>
                            <input type="number" id="maxConcurrentTrades" name="max_concurrent_trades"
                                   min="1" max="100" value="15">
                            <small class="form-help">Maximum total trades across all pairs</small>
                        </div>

                        <div class="form-group">
                            <label for="portfolioRiskPercent">Portfolio Risk Limit (%)</label>
                            <input type="number" id="portfolioRiskPercent" name="portfolio_risk_percent"
                                   step="0.5" min="1" max="50" value="10.0">
                            <small class="form-help">Maximum total portfolio risk percentage</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="stopLossPips">Default Stop Loss (Pips)</label>
                            <input type="number" id="stopLossPips" name="stop_loss_pips"
                                   min="5" max="500" value="50">
                            <small class="form-help">Default stop loss distance in pips</small>
                        </div>

                        <div class="form-group">
                            <label for="takeProfitPips">Default Take Profit (Pips)</label>
                            <input type="number" id="takeProfitPips" name="take_profit_pips"
                                   min="10" max="1000" value="100">
                            <small class="form-help">Default take profit distance in pips</small>
                        </div>
                    </div>
                </div>

                <!-- Currency Pairs Tab -->
                <div id="currenciesTab" class="tab-content">
                    <h3>Currency Pairs Configuration</h3>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addCurrencyPair()">
                            <i class="fas fa-plus"></i> Add Currency Pair
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="loadDefaultPairs()">
                            <i class="fas fa-magic"></i> Load Default Pairs (EURUSD, GBPUSD, etc.)
                        </button>
                    </div>

                    <div id="currencyPairsList" class="currency-pairs-container">
                        <!-- Currency pairs will be added dynamically -->
                    </div>
                </div>

                <!-- Strategy Tab -->
                <div id="strategyTab" class="tab-content">
                    <h3>Trading Strategy Settings</h3>

                    <div class="form-group">
                        <label for="strategyType">Strategy Type</label>
                        <select id="strategyType" name="strategy_type">
                            <option value="SIMPLE_MA" selected>Simple Moving Average</option>
                            <option value="RSI">RSI (Relative Strength Index)</option>
                            <option value="MACD">MACD (Moving Average Convergence Divergence)</option>
                            <option value="BOLLINGER_BANDS">Bollinger Bands</option>
                            <option value="MULTI_INDICATOR">Multi-Indicator</option>
                            <option value="ML_STRATEGY">ML Strategy (Machine Learning)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="timeframe">Timeframe</label>
                        <select id="timeframe" name="timeframe">
                            <option value="M1">M1 (1 Minute)</option>
                            <option value="M5" selected>M5 (5 Minutes)</option>
                            <option value="M15">M15 (15 Minutes)</option>
                            <option value="M30">M30 (30 Minutes)</option>
                            <option value="H1">H1 (1 Hour)</option>
                            <option value="H4">H4 (4 Hours)</option>
                            <option value="D1">D1 (Daily)</option>
                            <option value="W1">W1 (Weekly)</option>
                            <option value="MN1">MN1 (Monthly)</option>
                        </select>
                    </div>

                    <div id="strategyParamsSection">
                        <!-- Strategy-specific parameters -->
                        <div id="simpleMAParams">
                            <h4>Moving Average Parameters</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fastPeriod">Fast MA Period</label>
                                    <input type="number" id="fastPeriod" name="fast_period"
                                           min="5" max="200" value="10">
                                </div>
                                <div class="form-group">
                                    <label for="slowPeriod">Slow MA Period</label>
                                    <input type="number" id="slowPeriod" name="slow_period"
                                           min="10" max="500" value="20">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Position Management Tab -->
                <div id="positionTab" class="tab-content">
                    <h3>Position Management</h3>

                    <div class="form-section">
                        <h4>Breakeven Settings</h4>
                        <label class="checkbox-label">
                            <input type="checkbox" id="enableBreakeven" name="enable_breakeven" checked>
                            Enable Breakeven
                        </label>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="breakevenTrigger">Trigger (Pips in Profit)</label>
                                <input type="number" id="breakevenTrigger" name="breakeven_trigger_pips"
                                       step="1" min="5" max="100" value="15">
                            </div>
                            <div class="form-group">
                                <label for="breakevenOffset">Offset (Pips Above Entry)</label>
                                <input type="number" id="breakevenOffset" name="breakeven_offset_pips"
                                       step="0.5" min="0" max="20" value="2">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Trailing Stop Settings</h4>
                        <label class="checkbox-label">
                            <input type="checkbox" id="enableTrailing" name="enable_trailing" checked>
                            Enable Trailing Stop
                        </label>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="trailingStart">Start Trailing (Pips in Profit)</label>
                                <input type="number" id="trailingStart" name="trailing_start_pips"
                                       step="1" min="10" max="200" value="20">
                            </div>
                            <div class="form-group">
                                <label for="trailingDistance">Trailing Distance (Pips)</label>
                                <input type="number" id="trailingDistance" name="trailing_distance_pips"
                                       step="1" min="5" max="100" value="10">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Partial Close Settings</h4>
                        <label class="checkbox-label">
                            <input type="checkbox" id="enablePartialClose" name="enable_partial_close">
                            Enable Partial Close
                        </label>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="partialClosePercent">Close Percentage (%)</label>
                                <input type="number" id="partialClosePercent" name="partial_close_percent"
                                       step="5" min="10" max="90" value="50">
                            </div>
                            <div class="form-group">
                                <label for="partialCloseProfit">Trigger Profit (Pips)</label>
                                <input type="number" id="partialCloseProfit" name="partial_close_profit_pips"
                                       step="5" min="10" max="200" value="25">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountConfigModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-info" onclick="previewConfig()">
                        <i class="fas fa-eye"></i> Preview Config
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="js/worker-connector.js?v=1766210522"></script>
    <script src="js/accounts.js?v=1766210522"></script>
    <script src="js/account-config.js?v=1766210522"></script>
</body>
</html>
